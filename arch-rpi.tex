\documentclass[12pt,letterpaper]{article}

\usepackage{booktabs,longtable,tabu} % for nice-looking tables
\usepackage[binary-units=true]{siunitx} % for units
\usepackage{listings} % for code
\usepackage[grumpy]{gitinfo} % for Git hash (i.e. versioning)
\usepackage{underscore} % so you can use underscores
\usepackage{pdflscape} % for bill of materials page
\usepackage{graphicx}
\usepackage{multirow}
\usepackage{amsmath,amssymb}
%\usepackage{schemata} % stretchy curly braces in text mode %% looks like I can only get left-pointing braces, and I need right-pointing braces
\usepackage{hyperref}
\usepackage[svgnames,dvipsnames]{xcolor}
\usepackage{textcomp} % enables upquote, textlangle, textrangle
\usepackage{datetime}
\usepackage{calc}
\usepackage{mdframed}
\usepackage{fontenc} % slanted tt font

\usepackage{fixltx2e}


\yyyymmdddate

\newcommand\gittext[1]{\texttt{#1}}

\newcommand\siwordspace{\,}
\DeclareSIUnit\block{\siwordspace block}
\DeclareSIUnit\blocks{\siwordspace blocks}
\DeclareSIUnit\bytes{\siwordspace bytes} % for when you want "bytes" spelled out

\sisetup{%
	digitsep=comma,
}

\newcommand\Emph[1]{\textbf{#1}}
\newcommand\EMPH[1]{\textbf{\textit{#1}}}

\renewcommand{\sfdefault}{phv} % phv is Helvetica
\urlstyle{sf}
\hypersetup{%
	colorlinks=true,
	linkcolor=MediumVioletRed, 
		%blue,
	urlcolor=Blue,
}
\newcommand\styledhref[2]{\href{#1}{\sf #2}}

\newcommand\high{\textsc{high}}
\newcommand\low{\textsc{low}}

% keyboard input
\newcommand\kbd[1]{\textlangle\texttt{#1}\textrangle}
\newcommand\return{RETURN}


%\renewcommand{\thefootnote}{\fnsymbol{footnote}}

%%%% listings stuff

%% define slanted tt font
\newcommand\sltt{%
	\fontfamily{cmtt}%
	\fontseries{m}%
	\fontshape{sl}%
	\selectfont%
}

%% define bf tt font
\newcommand\bftt{%
	\fontfamily{lmtt}% %% you need to switch to latin modern typewriter text, which is similar to computer modern typewriter text (source: http://tex.stackexchange.com/questions/11498/bold-typewriter-type-fonts)
	\fontseries{bx}%
	%\fontshape{n}%
	\selectfont%
}

\setlength\parskip{2pt plus2pt minus2pt}
\setlength\parindent{0pt}


%% xcolor package
\definecolor{codebg}{HTML}{EEEEEE}
%\definecolor{codebg}{HTML}{333333} %% this shows off the ugly white lines between code lines, which you need to fix 
\definecolor{codeframe}{HTML}{CCCCCC}

\newcommand\UserSpecificInputStyle{\color{Purple}\sltt}
\newcommand\UserSpecificEnvironmentVariables{\color{DarkBlue}\sltt}
\newcommand\ListingEmphasis{\sltt}
\newcommand\ListingStrongEmphasis{\bftt\color{Sepia}}
\newcommand\UserTyping{\color{Green}}
\newcommand\KeyboardInput{\color{Green}}

\lstset{%
	backgroundcolor=\color{codebg},
	%language=bash,
	frame=single,
	framesep=2pt,
	rulecolor=\color{codeframe},
	%upquote=true, %% the terminal output on the Pi doesn't appear to use upquotes, so why should I?
	basicstyle=\ttfamily,
	breaklines=true,
	postbreak=\raisebox{0ex}[0ex][0ex]{\ensuremath{\color{Red}\hookrightarrow\space}},
	commentstyle=\ttfamily,
	belowskip=-2pt,
	aboveskip=6pt,
	% delimits user-specific inputs -- should be surrounded by <> so you have <//<user-specific input>//>
	moredelim=[is][\UserSpecificInputStyle]{//<}{>//}, % [is] means delimiteres are invisible, not nestable
	% user-specific environment variables
	moredelim=[is][\UserSpecificEnvironmentVariables]{+//<}{>//+},
	% emphasis in listing
	moredelim=[is][\ListingEmphasis]{//|}{//|},
	% stronger emphasis in listing
	moredelim=[is][\ListingStrongEmphasis]{//*}{//*},
	% what the user should type in
	moredelim=[is][\UserTyping]{//[}{//]},
	% keyboard inputs, surround with <> so you have <///[[RETURN///]]>, for example
	moredelim=[is][\KeyboardInput]{//[[}{//]]},
}

%\newenvironment{aside}
%	{\begin{mdframed}[style=0,%
%		leftline=false,rightline=false,leftmargin=2em,%rightmargin=2em,%
%		innertopmargin=8pt,innerbottommargin=2pt,%
%		innerleftmargin=0pt,innerrightmargin=0pt,linewidth=0.5pt,%
%		skipabove=2pt,skipbelow=2pt]}
%	{\end{mdframed}}

\begin{document}


\title{Arch Linux on the Raspberry Pi}
\author{Ryan Matlock, Magzor Corp.\thanks{Last commit: \gittext{\gitAbbrevHash} by \gittext{\gitAuthorName} on \gittext{\gitAuthorIsoDate}}}
\date{\today}
\maketitle

\begin{abstract}
Arch is a Linux distribution built around ``\href{https://wiki.archlinux.org/index.php/The_Arch_Way}{The Arch Way},''\footnote{\url{https://wiki.archlinux.org/index.php/The_Arch_Way}} a philosophy of simplicity, code-correctness, user-centricity, openness, and freedom.  Simplicity lends itself to a minimalist approach, which in turn leads to lower system resource overhead---exactly what one wants in an embedded system.  Code-correctness means that the software is clean, correct, and simple, which implies a greater degree of comprehensibility and predictability, albeit sometimes accompanied with a steeper learning curve.  User-centricity, not to be confused with user-friendliness, manifests itself as giving the user complete control over their %% using a plural pronoun (e.g. they, them, their) with a singular antecdent has a rich history in English going back to at least the 16th century, and it's preferable to using singular masculine pronouns everywhere or coining new singular pronouns
system.  %But as Spiderman's Uncle Ben (or maybe Voltaire) said, ``With great power comes great responsibility,'' which in the case of Arch means that a do-it-yourself approach to problems is expected.
Openness and freedom allow for greater control of the system; as Arch Linux's founder, Judd Vinet said, ``[Arch Linux] is what \emph{you} make it.''
\end{abstract}

\tableofcontents

%\the\parskip

%\lstinline[backgroundcolor=\color{codebg}]{hi there} %% turns out background coloring of lstinline text is slightly nontrivial

\section{Overview}
This guide aims to show the reader how to
\begin{enumerate}
\item install Arch Linux for Raspberry Pi onto a blank SD card,
\item expand the root partition to fill the disk,
\item add a new user,
\item modify user groups and grant superuser privileges,
\item establish wireless connectivity,
\item enable SSH access,
\item install GNU Compiler Collection (GCC), % 4.9+ because of C++11 support (see: http://gcc.gnu.org/projects/cxx1y.html)
\item install Python 3,
\item install Git,
\item install GNU Emacs 24+,
\item set up Emacs,
\item install WiringPi library,
\item install pigpio library,
\item install RPi.GPIO library,
%\item install GNU nano, %% nano is already installed
\item \ldots
\item ??? install watchdog d\ae mon -- reboots Pi on failure \url{http://pi.gadgetoid.com/article/who-watches-the-watcher}
\item ??? install Lynx (text-based web browser)
\end{enumerate}

\section{Syntax Guide}
In order to avoid any confusion, here's a brief overview of the special syntax---all of which is assumed to be rendered in \texttt{typewriter text}---used in this document:
\begin{table}[!h]\centering
\caption{\label{tab:syntax} Syntax guide}\smallskip
\begin{tabu}{@{} p{0.35\textwidth} l p{0.35\textwidth} @{}}
\toprule
Description & Example & Meaning \\
\midrule
bracketed purple slanted text & \lstinline{<//<username>//>} & something to be entered by the user, the exact choice of which is up to them (note that brackets are to be omitted) \\
green text & \lstinline{//[n//]} & exact user input, often found in a large block of prompts and outputs \\
bracketed green text & \lstinline{<//[[RETURN//]]>} & special key input \\
red hook right arrow & \raisebox{0ex}[0ex][0ex]{\ensuremath{\color{Red}\hookrightarrow\space}} & line continuation character (i.e.\ in actual input/output, there is no linebreak) \\
plain text following \lstinline{$} or \lstinline{#} (shell prompt) & \lstinline{reboot} & text between shell prompt and end of line should be entered by the user \\
slanted text & \lstinline{//|emphasized//|} & emphasized text \\
bold sepia text & \lstinline{//*Emphasized!//*} & strongly emphasized text (generally to highlight a letter that you might otherwise miss) \\
\bottomrule
\end{tabu}
\end{table}

\section{Configuring Arch: The Hard Way}

\subsection{Installation}
%\begin{enumerate}
%\item 
Download the Arch Linux disk image from \url{http://archlinuxarm.org/platforms/armv6/raspberry-pi} and follow the instructions.
(Note: for Mac OS X\footnote{The \lstinline{bash} terminal is assumed to be used, so user input lines are started with \lstinline{$}.  Later, the \lstinline{tty} prompt of Arch will start user input lines with \lstinline{#}%, although I'm going to go with \lstinline{>} because the \LaTeX\ \lstinline{listings} package treats \lstinline{#} as a comment %% added commenstyle=\ttfamily to lstset, so it's not a problem
.}, the process is a little different\footnote{source: \url{http://www.embeddedarm.com/support/faqs.php?item=10}}:

\begin{enumerate}
\item Plug in your SD card and run

\begin{lstlisting}
$ diskutil list
\end{lstlisting}

to find the \lstinline{/dev/diskN} node (e.g. \lstinline{disk3}, which is the \lstinline{sdX} in the linked instructions) on which it's located.

\item Unmount the drive by running

\begin{lstlisting}
$ diskutil unmountDisk /dev/diskN
\end{lstlisting}

which will print

\begin{lstlisting}
Unmount of all volumes on diskN was successful
\end{lstlisting}

if successful.

\item Write the Arch image by running

\begin{lstlisting}
$ dd bs=1m if=/path/to/ArchLinuxARM*-rpi.img of=/dev/rdiskN
\end{lstlisting}
as root\footnote{Some guides recommend using \lstinline{of=/dev/diskN} instead of \lstinline{of=/dev/diskN} for increased security as \lstinline{rdiskN} is the raw path, while \lstinline{diskN} is a buffered device. (source: % note that with hyperref package, certain characters (e.g. #) must be escaped with a slash in the URL
\url{http://elinux.org/RPi_Easy_SD_Card_Setup\#Flashing_the_SD_card_using_Mac_OS~X}) }. %(this may take awhile\footnote{approximately 6 minutes on a 2010 MacBook Pro onto a Class~10 \SI{16}{\giga\byte} SD card}---especially if you omit the \lstinline{bs=1m} part).
Personal testing revealed that

tested on identical Class 4, \SI{4}{\giga\byte} SD cards:
\begin{lstlisting}
matlocksmacbook:~ matlock$ sudo dd bs=1m if=~/Downloads/ArchLinuxARM-2014.04-rpi.img of=/dev/disk4
1870+0 records in
1870+0 records out
1960837120 bytes transferred in 452.680379 secs (4331615 bytes/sec)
\end{lstlisting}

\begin{lstlisting}
matlocksmacbook:~ matlock$ sudo dd bs=1m if=~/Downloads/ArchLinuxARM-2014.04-rpi.img of=/dev/rdisk4
Password:
1870+0 records in
1870+0 records out
1960837120 bytes transferred in 394.117681 secs (4975258 bytes/sec)
\end{lstlisting}

\end{enumerate}

%\end{enumerate}

\subsection{Expanding the Root Partition}
%\lstset{language=sh}

When you first boot up the Pi with a fresh Arch Linux installation, you will eventually be greeted with something like

\begin{lstlisting}
Arch Linux 3.10.35-1-ARCH (tty1)

alarmpi login:
\end{lstlisting}
for which the username and password are simply \lstinline{root}.

\begin{enumerate}
\item Begin\footnote{%sources: \url{http://raspberrypi.stackexchange.com/questions/499/how-can-i-resize-my-root-partition} and 
source:
\url{http://jan.alphadev.net/post/53594241659/growing-the-rpi-root-partition}} by logging in as \lstinline{root}.

\item Run \lstinline{fdisk} on the SD card with
\begin{lstlisting}
# fdisk /dev/mmcblk0
\end{lstlisting}

\item
Print the partition table, which looks something like the following\footnote{This example was performed on a \SI{4}{\giga\byte} class~4 SanDisk SDHC card.  With the exception of the \lstinline{Disk} and \lstinline{Disk identifier} entries, all the numbers are in agreement with those posted on the previously referenced Jan's Stuff ``Growing the RPi root partition'' blog entry (but that concerned a \SI{32}{\giga\byte} disk, and the identifier is presumably unique).}:


%%\newlength{\enumitextwidth}
%%%% using calc package
%%\setlength{\enumitextwidth}{\textwidth-\leftmargin}
%%
%%\begin{minipage}[!h]{\enumitextwidth}\footnotesize
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
Command (m for help): //[p//]

Disk /dev/mmcblk0: 3.7 GiB, 3965190144 bytes, 7744512 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x417ee54b

Device         Boot  Start      End   Blocks Id System
/dev/mmcblk0p1        2048   186367    92160  c W95 FAT32 (LBA)
/dev/mmcblkp2       186368  3667967  1740800  5 Extended
/dev/mmcblkp5       188416  3667967  1739776 83 Linux
\end{lstlisting}
%%\end{minipage}

The first partition is the boot partition.  The second is an extended partition used to overcome the 4~primary partition limit.  The third partition---that is, partition~5---is contained within partition~2, and holds only \SI{849.5}{\mebi\byte}\footnote{%% I might be wrong here because when I try this calculation on the properly resized partition, which fdisk tells me is 3.6 GiB, I get exactly half of that
%The figure was arrived at in the following manner:
%\begin{equation*}
%\SI{1739776}{\blocks}\cdot\frac{\SI{512}{\bytes}}{\SI{1}{\block}}\cdot\frac{\SI{1}{\mebi\byte}}{1024\cdot\SI{1024}{\bytes}}=\SI{849.5}{\mebi\byte}.
%\end{equation*}
%Sorry, Jan, but I think you may have made a mistake in your calculation.
%
%Also, n
Note the distinction between \si{\mebi\byte} (1~mebibyte \(=1024\cdot1024\) bytes) and \si{\mega\byte} (1 megabyte \(=10^6\) bytes).  I've tried to be consistent in this document, but mistakes have a way of creeping in, and it's ultimately not terribly important.}, which is only a fraction of the disk's available space.

\item Now we must delete partition~2:
\begin{lstlisting}
Command (m for help): //[d//]

Partition number (1,2,5, default 5): //[2//]
Partition 2 has been deleted.
\end{lstlisting}

If you print the partition table (i.e.\ enter \lstinline{//[p//]}), you'll see that partition~5 is also gone because it was contained within partition~2.

% and here marks the dramatic shift in tone that occurred between when this document was started and when it was resumed
\item We will now recreate the extended partition.  Add a new partition in the following manner\footnote{Rather than pressing \kbd{\return} where indicated, you could manually enter the number, make a mistake, and \emph{ruin everything}, but I think the former way is easier since the latter still involves pressing \kbd{\return}.}:

\begin{lstlisting}
Command (m for help): //[n//]

Partition type:
  p  primary (1 primary, 0 extended, 3 free)
  e  extended
Select (default p): //[e//]
Partition number (2-4, default 2): //[2//]
First sector (186368-7744511, default 186368):
<//[[RETURN//]]>
Last sector, +sectors or +size{K,M,G,T,P} (186368-7744511, default 7744511):
<//[[RETURN//]]>
Created a new partition 2 of type 'Extended' and a size of 3.6 GiB.
\end{lstlisting}

The extended partition has now been created, but this time it occupies the disk space not taken up by the boot partition.

\item \label{item:root} The root partition will now be recreated following a similar process.  For the sake of brevity, I won't detail each step but instead show it done all at once.

Note: it is \emph{absolutely critical} that the first block of the old and new partition match.  The data within the old partition is still there; all we're doing is resizing the partition while keeping its data intact.  Changing the starting block can (and almost assuredly will) render useless the data we want to preserve.
\begin{lstlisting}
Command (m for help): //[n//]

Partition type:
  p  primary (1 primary, 1 extended, 2 free)
  l  logical (numbered from 5)
Select (default p): //[l//]

Adding logical partition 5
First sector (188416-7744511, default 188416):
<//[[RETURN//]]>
Last sector, +sectors or +size{K,M,G,T,P} (188416-7744511, default 7744511):
<//[[RETURN//]]>
Created a new partition 5 of type 'Linux' and of size 3.6 GiB.
\end{lstlisting}
Success!

\item Well, not so fast.  We haven't actually written any of our changes yet, and we also want to make sure that we got the first block of our root partition right (see the note in step~\ref{item:root}).

%To do that, enter \lstinline{p}, and you should see the following:
To do that, print the partition table:
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
Command (m for help): //[p//]

Disk /dev/mmcblk0: 3.7 GiB, 3965190144 bytes, 7744512 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0x417ee54b

Device         Boot   Start      End  Blocks  Id System
/dev/mmcblk0p1         2048   186367   92160   c W95 FAT32 (LBA)
/dev/mmcblk0p2       186368  7744511 3779072  5 Extended
/dev/mmcblk0p5       186416  7744511 3778048 83 Linux
\end{lstlisting}
Looks like everything checks out, so %enter \lstinline{w} to write the changes, which will give the following message (and should not cause you to worry):
write the table to disk and exit (and don't worry about the failure warning):
\begin{lstlisting}
Command (m for help): //[w//]
The partition table has been altered.
Calling ioctl() to re-read partition table.
Re-reading the partition table failed.: Device or resource busy

The kernel still uses the old table. The new table will be used at the next reboot or after you run partprobe(8) or kpartx(8).
\end{lstlisting}

\item Reboot the system:
\begin{lstlisting}
# reboot
\end{lstlisting}

\item When the system restarts, log back in as \lstinline{root}.

\item (optional) We will use \lstinline{resize2fs} to actually resize the partitions, but first, let's run \lstinline{df} and see what our filesystem looks like currently (displayed in an abbreviated form):
\begin{lstlisting}[basicstyle=\ttfamily\scriptsize]
# df
Filesystem       1K-blocks   Used Available Use% Mounted on
/dev/root          1679632 441176   1135084  28% /
...
/dev/mmcblk0p1       91962  25328     66634  28% /boot
...
\end{lstlisting}

\item Now it's time to use \lstinline{resize2fs}:
\begin{lstlisting}
# resize2fs /dev/mmcblk0p5
resize2fs 1.42.9 (28-Dec-2013)
Filesystem at /dev/mmcblk0p5 is mounted on /; on-line resizing requited
old_desc_blocks = 1, new_desc_blocks = 1
The filesystem on /dev/mmcblk0p5 is now 944512 blocks long.
\end{lstlisting}

\item (optional) Finally, we'll run a quick check with \lstinline{df} to see how our filesystem looks now:
\begin{lstlisting}[basicstyle=\ttfamily\scriptsize]
# df
Filesystem       1K-blocks   Used Available Use% Mounted on
/dev/root          3688608 442024   3065496  13% /
...
/dev/mmcblk0p1       91962  25328     66634  28% /boot
...
\end{lstlisting}
Now only 13\% of the root partition is being used instead of 28\%, which is a quick and easy sanity check.
\end{enumerate}

\subsection{Enabling Wireless Connectivity}
Because of Arch's minimalist approach, very little software is included out of the box---not even something as common as \lstinline{sudo}!  As a result, establishing an internet connection so that additional packages can be downloaded is a high priority in any new Arch installation.  In this case, we're going to assume a wireless connection is being used\footnote{sources: \url{https://wiki.archlinux.org/index.php/Wireless_network_configuration} and \url{http://raspberrypi.stackexchange.com/questions/7987/wifi-configuration-on-arch-linux-arm}}, specifically a USB wifi adapter\footnote{In my particular case, I'm using an \styledhref{http://lmgtfy.com/?q=\%22Edimax+EW-7811Un\%22}{Edimax EW-7811Un 802.11n USB wifi adapter}}.

\begin{enumerate}
\item First, the wireless device driver must be determined to be correctly installed.  The Arch wiki suggests checking the output of
\begin{lstlisting}
# lsusb -v
\end{lstlisting}
but it appears to produce screenfuls of output that would only be helpful to the kind of person not reading this document.  The other suggestion is to look at the output of
\begin{lstlisting}
# dmesg | grep usbcore
\end{lstlisting}
which for me output a few lines, one of which was
\begin{lstlisting}
[   9.216794] usbcore: registered new interface driver rt18192cu
\end{lstlisting}
which is what the wiki said to expect.  

\item Check the output of
\begin{lstlisting}
# ip link
\end{lstlisting}
which in my case has five entries, the last of which is what we're looking for (i.e. something starting with a w, like \lstinline{wlan0}):
\begin{lstlisting}
...
5: wlan0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 80:1f:02:bf:11:68 brd ff:ff:ff:ff:ff:ff
\end{lstlisting}

\item Run
\begin{lstlisting}
# ip link set wlan0 up
\end{lstlisting}
If you see the message
\begin{lstlisting}
SIOCSIFFLAGS: No such file or directory
\end{lstlisting}
your wireless device requires firmware to be properly installed and configured.  Since everything seems to be working for me, you can work out the details for yourself if you've encountered an issue at this point.

% nevermind, netctl is already there
%\item Install \lstinline{netctl} with the command
%\begin{lstlisting}
%# pacman -S netctl
%\end{lstlisting}

\item Copy a \lstinline{netctl} profile\footnote{In this case, I'm assuming that you're connecting to a network with WPA/WPA2 encryption.  If you want to see what other examples are available, run \lstinline{# ls /etc/netctl/examples}.}:
\begin{lstlisting}
# cp /etc/netctl/examples/wireless-wpa /etc/netctl/<//<profile>//>
\end{lstlisting}

\item Edit the newly-copied \lstinline{<//<profile>//>} with \lstinline{nano} or \lstinline{vi}\footnote{There may be other editors included in Arch, but \lstinline{# which ed} and \lstinline{# which emacs} both failed, so I'm guessing our choices are very limited.  For the record, between \lstinline{nano} and \lstinline{vi}, I recommend \lstinline{nano}.}:
\begin{lstlisting}
# nano /etc/netctl/<//<profile>//>
\end{lstlisting}
so that it looks something like
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
Description='<//<a descriptive phrase>//>'
Interface=<//<wifi card name>//>
Connection=wireless
Security=wpa

IP==dhcp

ESSID='<//<wifi network name>//>'
# Prepend hexadecimal keys with \"
# If your key starts with ", write it as '""<key>"'
# See also: the section on special quoting rules in netctl.profile(5)
Key='<//<wifi password>//>' # pick something strong that incorporates letters and numbers like 'password123'
# Uncomment this if your ssid is hidden
#Hidden=yes
\end{lstlisting}
where \lstinline{<//<wifi card name>//>} is probably something like \lstinline{wlan0}.

\item Start your \lstinline{netctl} profile:
\begin{lstlisting}
# netctl start <//<profile>//>
\end{lstlisting}
where \lstinline{<//<profile>//>} is simply the profile name and \emph{not} the full path, which will result in \lstinline{netctl} exiting with an error code.

\item Enable \lstinline{netctl} profile to run on startup\footnote{Technically, this enables a \lstinline{systemd} service that starts on startup, but why bother with the details when you're using Arch?}:
\begin{lstlisting}
# netctl enable <//<profile>//>
\end{lstlisting}

\end{enumerate}

\subsubsection{Additional \lstinline{netctl} Information}
There are a few more helpful commands to know with \lstinline{netctl}.  In the event you encounter an error, you can generate status logs with
\begin{lstlisting}
# journalctl -xn
\end{lstlisting}
and
\begin{lstlisting}
# netctl status <//<profile>//>
\end{lstlisting}

If you modify your \lstinline{netctl <//<profile>//>}, the changes do not propagate to the service file until you run
\begin{lstlisting}
# netctl reenable <//<profile>//>
\end{lstlisting}

\subsection{Adding a User}

It's generally considered unsafe to log in as root\footnote{see \url{http://www.slackbook.org/html/shell.html} and \url{http://lmgtfy.com/?q=why+shouldn\%27t+you+log+in+as+root}}, so we will add a user\footnote{source: \url{https://wiki.archlinux.org/index.php/users_and_groups}}.  To see what users currently exist, run

\begin{lstlisting}
# cat /etc/passwd
\end{lstlisting}
which lists users in the format
\begin{lstlisting}
account:password:UID:GID:GECOS:directory:shell
\end{lstlisting}
where \lstinline{UID} is the user ID, \lstinline{GID} is the primary group ID, \lstinline{GECOS} is an optional field usually containing the full user name, \lstinline{directory} is the path of \lstinline{$HOME}, and \lstinline{shell} is the user's command interpreter, which defaults to \lstinline{/bin/sh}.

Adding a user is straightforward, and uses the following syntax:

\begin{lstlisting}
# useradd -m -g <//<initial group>//> -G <//<additional groups>//> -s <//<login shell>//> <//<username>//>
\end{lstlisting}
We'll worry about groups in the next section, so for now enter something like
\begin{lstlisting}
# useradd -m -s /bin/bash matlock
\end{lstlisting}
although I generally suggest you pick a different username unless you're a relative or an Andy Griffith fan.

To change the password, enter
\begin{lstlisting}
# passwd <//<username>//>
\end{lstlisting}
which in my case is set to \lstinline{**********}.

To force a user to change this password on their first login, run
\begin{lstlisting}
chage -d 0 <//<username>//>
\end{lstlisting}
(Yes, that's right, it's \lstinline{chage}, not change---remember that \lstinline{ch//|age//|} deals with password \emph{age}, not password change.)

The \lstinline{GECOS} field is edited by issuing the command
\begin{lstlisting}
# chfn <//<username>//>
\end{lstlisting}
but doing so is not especially important.

%\begin{aside}
If you're ever curious as to what user you are, it's a simple as
\begin{lstlisting}
# whoami
\end{lstlisting}
which may be among the least arcane Linux commands.
%\end{aside}

To switch between users,
\begin{lstlisting}
# logout
\end{lstlisting}

\subsection{User Groups}
%As it stands, our new user doesn't have as many privileges as \lstinline{root}.  This is desireable because it limits the amount of damage that can be done by a user.

To add a user to a group or groups, run
\begin{lstlisting}
# usermod -aG <//<additional groups>//> <//<username>//>
\end{lstlisting}
Note that if the \lstinline{-a} flag is omitted, the user is removed from all groups not explicity named in \lstinline{<//<additional groups>//>}.  For the sake of clarity, here are the groups to which I added \lstinline{matlock}:
\begin{lstlisting}
# usermod -aG users,rfkill,wheel matlock
\end{lstlisting}
None of documentation I found explictly stated that \lstinline{<//<additional groups>//>} is a list of groups separated by commas without spaces, but that's probably obvious to most people.

You can verify that you've properly assigned groups to a user with the command
\begin{lstlisting}
# groups <//<username>//>
\end{lstlisting}

Before you go about adding a user to a group, it's helpful to know what groups exist, the purpose of existing groups, and how to create/delete groups.

First, listing groups is similar to listing users; it's simply
\begin{lstlisting}
# cat /etc/group
\end{lstlisting}
The main groups we care about are \lstinline{users}, \lstinline{rfkill}, and \lstinline{wheel}.  Granting membership to \lstinline{users} is a nice thing to do, \lstinline{rfkill} lets you turn off RF devices (e.g.\ Bluetooth and wifi), and \lstinline{wheel} is the typical name for the administrative group.

\subsection{Configuring \lstinline{sudo}}
\lstinline{sudo} grants the temporary privilege of \lstinline{root} to a non-root user and logs all commands and failed access attempts.  Working as a non-root user ensures that you're less likely to cause damage to your system through a mistake or a bug in a command you execute.

When you run a command through \lstinline{sudo}, you'll receive the following warning:
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.
\end{lstlisting}
It's a message that bears repeating.

\begin{enumerate}
\item Install\footnote{source: \url{https://wiki.archlinux.org/index.php/sudo}} \lstinline{sudo}:
\begin{lstlisting}
# pacman -S sudo
\end{lstlisting}

\item Print the current \lstinline{sudo} configuration:
\begin{lstlisting}
# sudo -ll
\end{lstlisting}
and do nothing with that information.  Hey, the wiki said to do it.  The output for me was as follows:
\begin{lstlisting}[basicstyle=\ttfamily\small]
User root may run the following commands on alarmpi:

Sudoers entry:
    RunAsUsers: ALL
    Commands:
        ALL
\end{lstlisting}

\item The configuration file for \lstinline{sudo}, \lstinline{/etc/sudoers}, should \EMPH{always} be edited with \lstinline{visudo} because it locks the \lstinline{sudoers} file, saves edits to a temporary file, and checks the syntax before copying it back to \lstinline{/etc/sudoers}.

Unfortunately but unsurprisingly, the default editor for \lstinline{visudo} is \lstinline{vi}.  You can fix this problem with
\begin{lstlisting}
# EDITOR=nano visudo
\end{lstlisting}
which will open \lstinline{sudoers} for editing.

Uncomment the line
\begin{lstlisting}
# %wheel ALL=(ALL) ALL
\end{lstlisting}
to give members of the \lstinline{wheel} group \lstinline{sudo} privileges.

To permanently set \lstinline{nano} as your \lstinline{visudo} \lstinline{EDITOR}, add the following to your \lstinline{sudoers} file:
\begin{lstlisting}
# Reset environment by default
Defaults env_reset
# set default EDITOR to nano, and do not allow visudo to use EDITOR/VISUAL
Defaults editor=/usr/bin/nano, !env_editor
\end{lstlisting}

Upon saving and exiting, running \lstinline{# sudo -ll} again produces
\begin{lstlisting}[basicstyle=\ttfamily\small]
User root may run the following commands on alarmpi:

Sudoers entry:
    RunAsUsers: ALL
    Commands:
        ALL
Sudoers entry:
    RunAsUsers: ALL
    Commands:
        ALL
\end{lstlisting}
which isn't necessarily what you'd expect.

\end{enumerate}

At this point, I highly encourage you to log out as \lstinline{root} and log in as the user you created.  Because we set \lstinline{bash} as our default terminal, lines will now start with \lstinline{$} instead of \lstinline{#}.

%% it's probably also a good idea to give root a new password

\subsubsection{Disabling \lstinline{root} Login}

\url{https://wiki.archlinux.org/index.php/sudo#Disable_root_login} (actually detail how to do this in here)

\subsection{Enabling SSH Access}

\begin{enumerate}
\item Now that we have an internet connection, we should sync our repo database and upgrade our system:
\begin{lstlisting}
$ sudo pacman -Syu
\end{lstlisting}
which should ensure that \lstinline{openssh} is up-to-date.

\item Check \lstinline{systemctl}\footnote{\lstinline{systemctl} seems to have replaced \lstinline{initscripts}, so ignore any advice that says you need to look at your \lstinline{/etc/rc.conf} file, which you probably don't even have!} to see if an SSH d\ae mon is running\footnote{Trust me, you don't want to leave off the \lstinline{| grep -i 'ssh'}---it's a bit much to read through.  Also, the \lstinline{-i} isn't strictly necessary in this case, but it gives you a case-insensitive search, which is nice.}:
\begin{lstlisting}
$ systemctl list-units | grep -i 'ssh'
\end{lstlisting}
which for me produced
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
sshd.service        loaded active running  OpenSSH Daemon
\end{lstlisting}

%%%% nevermind, this isn't working well for some reason -- it doesn't want to play nicely with \lstinline{~/sshd_config} no matter what
%%% Ok, I'm getting sick of typing (and mistyping) \lstinline all the time.  It turns out I can also do \lstMakeShortInline{} to define a character that lets me just do <char><lstinline stuff><char> instead, which is nice.  Also, \lstDeleteShortInline{} undoes it.  Way cool!
%\lstMakeShortInline{+}

\item Edit the SSH d\ae mon configuration file\footnote{If you omit \lstinline{sudo}, you won't have the necessary permissions to edit the file.  In case you forget (as I did upon doing this myelf), you can save it elsewhere (e.g. \lstinline{./sshd_config}, and if you're unsure what your current working directory is, run \lstinline{$ pwd}), exit \lstinline{nano}, and run \lstinline{$ sudo mv ./sshd_config /etc/ssh/sshd_config}.}:
\begin{lstlisting}
$ sudo nano /etc/ssh/ssh//*d//*_config
\end{lstlisting}
and add the lines
\begin{lstlisting}
AllowGroups users wheel
PermitRootLogin no
\end{lstlisting}
If you want a custom greeting, add the line
\begin{lstlisting}
Banner /etc/issue
\end{lstlisting}
and edit the file \lstinline{/etc/issue} (you'll need root permissions).

%\item (optional) To change the name of your Raspberry Pi, which is set to \lstinline{alarmpi} by default, you'll need to edit two files\footnote{source: \url{http://elinux.org/ArchLinux_Install_Guide\#Initial_Installation}}.
%\begin{enumerate}
%\item Edit \lstinline{/etc/hostname}:
%\begin{lstlisting}
%$ sudo nano /etc/hostname
%\end{lstlisting}
%and change \lstinline{alarmpi} to \lstinline{<//<new name>//>}.
%
%\item Edit \lstinline{/etc/hosts}:
%\begin{lstlisting}
%$ sudo nano /etc/hosts
%\end{lstlisting}
%and change the line
%\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
%127.0.0.1  localhost.localdomain localhost
%\end{lstlisting}
%to
%\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
%127.0.0.1  localhost.localdomain localhost <//<new name>//>
%\end{lstlisting}
%\end{enumerate}

\item (optional) To change the name of your Raspberry Pi\footnote{source: \url{https://wiki.archlinux.org/index.php/Network_configuration\#Set_the_hostname}}:

\begin{lstlisting}
$ sudo hostnamectl set-hostname <//<new name>//>
\end{lstlisting}

\end{enumerate}

That's it!  You can now connect to your Pi\footnote{If you've changed your Pi's hostname but previously connected to it through SSH before doing so, the computer through which you're trying to connect will likely have a line in \lstinline{$HOME/.ssh/known_hosts} that prevents you from connecting through the new name. (source: \url{https://bbs.archlinux.org/viewtopic.php?id=168055})  In my case, running \lstinline{$ dscacheutil -flushcache} fixed the issue.} by running the following on a computer connected to the same network as your Pi\footnote{I'm assuming you're connecting through port 22}:
\begin{lstlisting}
$ ssh -p 22 <//<username>//>@<//<hostname>//>
\end{lstlisting}
where \lstinline{<//<hostname>//>} is \lstinline{alarmpi} by default or \lstinline{<//<new name>//>} if you elected to change it.

Alternately, if you know your Pi's IP address, you can connect to it with\footnote{Again, assuming that you're going through port 22.}
\begin{lstlisting}
$ ssh -p 22 <//<username>//>@<//<IP address>//>
\end{lstlisting}

You can supposedly make your life more convenient with an \lstinline{ssh_config} file.  If that sounds appealing, see \href{http://nerderati.com/2011/03/simplify-your-life-with-an-ssh-config-file/}{Simplify your life with an SSH config file}\footnote{\url{http://nerderati.com/2011/03/simplify-your-life-with-an-ssh-config-file/}}.

%% see https://wiki.archlinux.org/index.php/Secure_Shell#Managing_the_sshd_daemon
%\begin{enumerate}
%\item In order to set the IP address, in your \lstinline{sshd_config} file, uncomment the line
%\begin{lstlisting}
%#ListenAddress 0.0.0.0
%\end{lstlisting}
%and change it to
%\begin{lstlisting}
%
%\end{lstlisting}
%\end{enumerate} 

%\end{enumerate}

\subsubsection{SSH Keys Versus Password Logins}
Using SSH keys is more secure\footnote{source: \url{https://wiki.archlinux.org/index.php/SSH_Keys}}, but for now, it's easier to go with password logins.

\subsection{Making Use of SSH}

Now we've set up SSH, I'd suggest that's how you connect to your Pi because it's just easier.

\subsection{Recommended Software}

The following subsections make heavy use of Arch's package management system, \lstinline{pacman}.
%\begin{lstlisting}
%$ pacman -S <//<package>//>
%\end{lstlisting}

\subsubsection{Installing the GNU Compiler Collection (GCC)}

Installing \lstinline{gcc} is as simple as
\begin{lstlisting}
$ sudo pacman -S gcc
\end{lstlisting}

\lstinputlisting[language=c,showstringspaces=false,basicstyle=\ttfamily\small]{hello-world.c}

\subsubsection{Installing Python 3}

\begin{lstlisting}
$ sudo pacman -S python
\end{lstlisting}

If you also want Python~2, replacing \lstinline{python} with \lstinline{python2} is all you need to do.

To test your Python installation, run
\begin{lstlisting}
$ python
\end{lstlisting}
you should see something like
\begin{lstlisting}
Python 3.4.0 (default, Apr 27 2014, 10:47:09) 
[GCC 4.8.2 20131219 (prerelease)] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>>
\end{lstlisting}
Of course, it's more satisfying if you try a hello world, which is just
\begin{lstlisting}[language=python,showstringspaces=false,basicstyle=\ttfamily]
>>> print("Hello, world!")
\end{lstlisting}

\subsubsection{Installing GNU Emacs}
\begin{lstlisting}
$ sudo pacman -S emacs
\end{lstlisting}

Be forewarned: Emacs is quite large---over \SI{330}{\mebi\bytes} when I installed it---but it's worth it.

\subsubsection{Emacs Setup}
Emacs is a very personal thing, but my general recommendation is to try
\begin{lstlisting}
$ mkdir ~/elisp
$ mkdir ~/.emacs.d
\end{lstlisting}
through SSH, and then, in another terminal, try
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
<+//<remote-comp>//+>: <+//<cwd>//+> <+//<remote username>//+>$ scp -P 22 ~/.emacs <//<username>//>@<//<hostname>//>:~/
<+//<remote-comp>//+>: <+//<cwd>//+> <+//<remote username>//+>$ -scp -r -P 22 ~/elisp/* <//<username>//>@<//<hostname>//>:~/elisp/
<+//<remote-comp>//+>: <+//<cwd>//+> <+//<remote username>//+>$ -scp -r -P 22 ~/.emacs.d/* <//<username>//>@<//<hostname>//>:~/.emacs.d/
\end{lstlisting}
which in my case looks like
\begin{lstlisting}[basicstyle=\ttfamily\footnotesize]
matlockmbp:~ matlock$ scp -P 22 ~/.emacs matlock@archrpi:~/
matlockmbp:~ matlock$ scp -r -P 22 ~/elisp/* matlock@archrpi:~/elisp/
matlockmbp:~ matlock$ scp -r -P 22 ~/.emacs.d/* matlock@archrpi:~/.emacs.d/
\end{lstlisting}

\section{Miscellaneous Useful Commands}

\subsection{Shutdown and reboot as user other than \lstinline{root}}
Shutdown:
\begin{lstlisting}
$ systemctl poweroff
\end{lstlisting}

Reboot
\begin{lstlisting}
$ systemctl reboot
\end{lstlisting}



\end{document}